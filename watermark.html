<!DOCTYPE html>

<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>åœ°é›·ç³»æ–‡å­— / åœ–ç‰‡ æµ®æ°´å°å·¥å…·</title>
<!-- èŒç³»åœ“é«”å­—å‹ (åœ°é›·ç³») -->
<link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Honk&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&amp;display=swap" rel="stylesheet"/>
<style>
  :root{
    --pink:#ff7fdf;   /* éœ“è™¹ç²‰ */
    --black:#111;
  }
  body{
    background:#faf6fc;
    font-family:"Mochiy Pop One",sans-serif;
    text-align:center;
    padding:24px;
    color:var(--black);
  }
  h2{margin:8px 0 16px}
  input,select,button,label{margin:6px;padding:4px 8px;font-family:inherit}
  button{cursor:pointer}
  canvas{border:1px solid #ddd;max-width:100%;margin-top:12px}
  #imageControls{display:none}
  .panel{border:2px dashed var(--pink);padding:10px;border-radius:10px;margin:10px 0}
</style>
<link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&amp;display=swap" rel="stylesheet"/><link href="https://fonts.googleapis.com/css2?family=Honk&amp;display=swap" rel="stylesheet"/><link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&amp;display=swap" rel="stylesheet"/></head>
<body>
<h2>ğŸ–¤ğŸ’— åœ°é›·ç³»æµ®æ°´å°ç”¢ç”Ÿå™¨ v2 ğŸ’—ğŸ–¤</h2>
<!-- ä¸»åœ– -->
<div class="panel">
<b>âŠ ä¸Šå‚³ä¸»è¦åœ–ç‰‡</b><br/>
<input accept="image/*" id="imageInput" type="file"/>
</div>
<!-- æµ®æ°´å°è¨­å®š -->
<div class="panel">
<b>â‹ é¸æ“‡æµ®æ°´å°é¡å‹</b><br/>
<label><input checked="" name="wmType" type="radio" value="text"/> æ–‡å­—</label>
<label><input name="wmType" type="radio" value="image"/> åœ–ç‰‡</label>
</div>
<!-- æ–‡å­—æ§åˆ¶ -->
<div class="panel" id="textControls">
<b>æ–‡å­—æµ®æ°´å°</b><br/>
<input id="watermarkText" placeholder="é è¨­ï¼šâ™¡ Jirai Kei â™¡" type="text"/><br/>
  å­—é«”å¤§å°(px)ï¼š<input id="fontSize" style="width:70px" type="number" value="48"/>
  é€æ˜åº¦ï¼š<input id="opacity" max="1" min="0" step="0.1" style="width:70px" type="number" value="0.8"/>
<br/>
  Font Style:
<select id="fontStyle">
<option value="Mochiy Pop One">Mochiy Pop One</option>
<option value="Honk">Honk</option>
<option value="UnifrakturMaguntia">UnifrakturMaguntia</option>
</select><br/>
</div>
<!-- åœ–ç‰‡æ§åˆ¶ -->
<div class="panel" id="imageControls">
<b>åœ–ç‰‡æµ®æ°´å°</b><br/>
<input accept="image/*" id="wmImageInput" type="file"/><br/>
  å¯¬åº¦(ä¸»åœ– %)ï¼š<input id="wmScale" style="width:70px" type="number" value="20"/> %
  é€æ˜åº¦ï¼š<input id="wmOpacity" max="1" min="0" step="0.1" style="width:70px" type="number" value="0.6"/>
</div>
<!-- å…±åŒè¨­å®š -->
<div class="panel">
<b>ä½ç½®</b>ï¼š
  <select id="position">
<option value="top-left">å·¦ä¸Š</option>
<option value="top-right">å³ä¸Š</option>
<option value="bottom-left">å·¦ä¸‹</option>
<option selected="" value="bottom-right">å³ä¸‹</option>
<option value="center">ä¸­å¤®</option>
</select><br/>
<button onclick="addWatermark()">åŠ ä¸Šæµ®æ°´å°</button>
<button onclick="downloadImage()">ä¸‹è¼‰åœ–ç‰‡</button>
</div>
<canvas id="canvas"></canvas>
<script>
const canvas = document.getElementById('canvas');
const ctx    = canvas.getContext('2d');
let baseImg  = null;    // ä¸»åœ–
let logoImg  = null;    // æ¼‚æµ®æ°´å°åœ– (è‹¥æœ‰)

// 1. ä¸»åœ–è®€å–
document.getElementById('imageInput').addEventListener('change',e=>{
  const file=e.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=evt=>{
    baseImg=new Image();
    baseImg.onload=()=>{
      canvas.width = baseImg.width;
      canvas.height= baseImg.height;
      ctx.drawImage(baseImg,0,0);
    };
    baseImg.src=evt.target.result;
  };
  reader.readAsDataURL(file);
});

// 2. æµ®æ°´å°é¡å‹åˆ‡æ›ï¼šé¡¯ç¤ºå°æ‡‰é¢æ¿
document.querySelectorAll("input[name='wmType']").forEach(r=>{
  r.addEventListener('change',()=>{
    const type=document.querySelector("input[name='wmType']:checked").value;
    document.getElementById('textControls').style.display  = (type==='text')  ? '' : 'none';
    document.getElementById('imageControls').style.display = (type==='image') ? 'block' : 'none';
  });
});

// 3. æµ®æ°´å°åœ–ç‰‡è®€å–
document.getElementById('wmImageInput').addEventListener('change',e=>{
  const file=e.target.files[0];
  if(!file) {logoImg=null;return;}
  const reader=new FileReader();
  reader.onload=evt=>{
    logoImg=new Image();
    logoImg.src=evt.target.result;
  };
  reader.readAsDataURL(file);
});

function addWatermark(){
  if(!baseImg) return alert("è«‹å…ˆä¸Šå‚³ä¸»è¦åœ–ç‰‡ï¼");
  // å…ˆé‡ç•«ä¸»åœ–
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(baseImg,0,0);

  const position=document.getElementById('position').value;
  const type    =document.querySelector("input[name='wmType']:checked").value;

  if(type==='text'){
    drawTextWm(position);
  }else{
    drawImageWm(position);
  }
}

/* ---------- æ–‡å­—æµ®æ°´å° ---------- */
function drawTextWm(position){
  const text     = document.getElementById('watermarkText').value || 'â™¡ Jirai Kei â™¡';
  const fontSize = parseInt(document.getElementById('fontSize').value||48);
  const opacity  = parseFloat(document.getElementById('opacity').value||0.8);
  const fontStyle = document.getElementById('fontStyle').value;
  const fontSpec = `${fontSize}px "${fontStyle}"`;

  document.fonts.load(fontSpec).then(() => {
  const text     = document.getElementById('watermarkText').value || 'â™¡ Jirai Kei â™¡';
  const fontSize = parseInt(document.getElementById('fontSize').value||48);
  const opacity  = parseFloat(document.getElementById('opacity').value||0.8);
  var fontStyle = document.getElementById('fontStyle').value;
  
      ctx.font = `${fontSize}px "${fontStyle}",sans-serif`;
  ctx.textBaseline = 'bottom';
  ctx.lineJoin     = 'round';

  const textW = ctx.measureText(text).width;
  let x=20,y=20+fontSize;

  switch(position){
    case 'top-right':    x=canvas.width-textW-20; y=fontSize+20;             break;
    case 'bottom-left':  x=20;                       y=canvas.height-20;     break;
    case 'bottom-right': x=canvas.width-textW-20;    y=canvas.height-20;     break;
    case 'center':       x=(canvas.width-textW)/2;   y=(canvas.height+fontSize)/2; break;
  }

  // éœ“è™¹
  ctx.shadowColor=`rgba(255,127,223,${opacity*0.6})`;
  ctx.shadowBlur =fontSize*0.6;
  // æé‚Š
  ctx.lineWidth  =fontSize*0.12;
  ctx.strokeStyle=`rgba(255,127,223,${opacity})`;
  ctx.strokeText(text,x,y);
  // å¡«è‰²
  ctx.fillStyle  =`rgba(17,17,17,${opacity})`;
  ctx.fillText(text,x,y);
      ctx.shadowBlur=0;
  });
}

/* ---------- åœ–ç‰‡æµ®æ°´å° ---------- */
function drawImageWm(position){
  if(!logoImg) return alert("è«‹å…ˆä¸Šå‚³æµ®æ°´å°åœ–ç‰‡ï¼");
  const scalePct = parseFloat(document.getElementById('wmScale').value||20) / 100;
  const opacity  = parseFloat(document.getElementById('wmOpacity').value||0.6);

  // è¨ˆç®—å¯¬é«˜ï¼šä¿æŒæ¯”ä¾‹ï¼Œå¯¬åº¦ = ä¸»åœ–å¯¬ * æ¯”ä¾‹
  const wmW = canvas.width * scalePct;
  const ratio = logoImg.width / logoImg.height;
  const wmH = wmW / ratio;

  let x=20, y=20;

  switch(position){
    case 'top-right':    x = canvas.width - wmW - 20;  y = 20;               break;
    case 'bottom-left':  x = 20;                       y = canvas.height - wmH - 20; break;
    case 'bottom-right': x = canvas.width - wmW - 20;  y = canvas.height - wmH - 20; break;
    case 'center':       x = (canvas.width - wmW)/2;   y = (canvas.height - wmH)/2;  break;
  }

  ctx.globalAlpha = opacity;
  ctx.drawImage(logoImg,x,y,wmW,wmH);
  ctx.globalAlpha = 1;  // é‚„åŸä¸é€æ˜åº¦
}

function downloadImage(){
  if(!baseImg) return;
  const link=document.createElement('a');
  link.download='watermarked.png';
  link.href=canvas.toDataURL();
  link.click();
}
</script>
</body>
</html>