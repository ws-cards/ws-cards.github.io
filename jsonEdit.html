<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>å¤šå¡ç‰‡ JSON ç·¨è¼¯å™¨</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .card-block { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; }
    .card-title { font-weight: bold; margin-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; max-width: 600px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    input[type="text"], input[type="number"] { width: 100%; }
    button { margin-top: 10px; margin-right: 10px; }
  </style>
</head>
<body>

<h2>å¤šå¡ç‰‡åƒ¹æ ¼ç·¨è¼¯å™¨</h2>

<!-- ä¸Šå‚³å€ -->
<label for="jsonFile">ğŸ“¥ ä¸Šå‚³ JSON æª”æ¡ˆï¼š</label>
<input type="file" id="jsonFile" accept=".json" onchange="handleFileUpload(event)">
<br><br>

<textarea id="jsonInput" style="width:100%; height:200px;">
{
  "OVL/SE51-39H": {
    "upddate": ["20250530", "20250531"],
    "displayName": ["OVL/SE51-39H_price"],
    "cardPrice": [50, 55]
  }
}
</textarea><br><br>

<!-- æŒ‰éˆ•å€ -->
<button onclick="renderEditor()">è½‰æ›æˆç·¨è¼¯ä»‹é¢</button>
<button onclick="generateJSON()">è¼¸å‡ºæ›´æ–°å¾Œ JSON</button>
<button onclick="downloadJSON()">ğŸ“¤ ä¸‹è¼‰ JSON</button>

<!-- ç·¨è¼¯å€ -->
<div id="editorContainer"></div>

<h3>è¼¸å‡ºçµæœï¼š</h3>
<pre id="output"></pre>

<script>
  // è™•ç†æª”æ¡ˆä¸Šå‚³
  function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('jsonInput').value = e.target.result;
      renderEditor();
    };
    reader.readAsText(file);
  }

  // å»ºç«‹è¡¨æ ¼
  function renderEditor() {
    const container = document.getElementById('editorContainer');
    container.innerHTML = '';
    const raw = JSON.parse(document.getElementById('jsonInput').value);

    for (const cardId in raw) {
      const data = raw[cardId];

      const block = document.createElement('div');
      block.className = 'card-block';
      block.setAttribute('data-card-id', cardId);
      block.setAttribute('data-display-name', data.displayName[0]);

      const title = document.createElement('div');
      title.className = 'card-title';
      title.textContent = `å¡ç‰‡åç¨±ï¼š${data.displayName[0]}ï¼ˆ${cardId}ï¼‰`;
      block.appendChild(title);

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = `<tr><th>æ—¥æœŸ</th><th>åƒ¹æ ¼</th><th>æ“ä½œ</th></tr>`;
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      data.upddate.forEach((date, i) => {
        tbody.appendChild(createRow(date, data.cardPrice[i]));
      });
      table.appendChild(tbody);
      block.appendChild(table);

      const addBtn = document.createElement('button');
      addBtn.textContent = 'â• æ–°å¢ä¸€ç­†';
      addBtn.onclick = () => {
        tbody.appendChild(createRow('', 0));
      };
      block.appendChild(addBtn);

      container.appendChild(block);
    }
  }

  // å»ºç«‹ä¸€ç­† row
  function createRow(dateVal, priceVal) {
    const row = document.createElement('tr');

    const dateTd = document.createElement('td');
    const dateInput = document.createElement('input');
    dateInput.type = 'text';
    dateInput.pattern = "\\d{8}";
    dateInput.value = dateVal;
    dateTd.appendChild(dateInput);
    row.appendChild(dateTd);

    const priceTd = document.createElement('td');
    const priceInput = document.createElement('input');
    priceInput.type = 'number';
    priceInput.value = priceVal;
    priceTd.appendChild(priceInput);
    row.appendChild(priceTd);

    const actionTd = document.createElement('td');
    const delBtn = document.createElement('button');
    delBtn.textContent = 'ğŸ—‘ï¸';
    delBtn.onclick = () => row.remove();
    actionTd.appendChild(delBtn);
    row.appendChild(actionTd);

    return row;
  }

  // å°‡ç·¨è¼¯çµæœè¼¸å‡ºæˆ JSONï¼ˆé¡¯ç¤ºç”¨ï¼‰
  function generateJSON() {
    const result = collectData();
    document.getElementById('output').textContent = JSON.stringify(result, null, 2);
  }

  // å°‡ç·¨è¼¯çµæœè¼¸å‡ºæˆ JSON æª”æ¡ˆ
  function downloadJSON() {
    const result = collectData();
    const blob = new Blob([JSON.stringify(result, null, 2)], { type: "application/json" });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = "cards.json";
    link.click();
  }

  // å…±ç”¨è³‡æ–™æ”¶é›†å™¨
  function collectData() {
    const blocks = document.querySelectorAll('.card-block');
    const result = {};

    blocks.forEach(block => {
      const cardId = block.getAttribute('data-card-id');
      const displayName = block.getAttribute('data-display-name');
      const rows = block.querySelectorAll('tbody tr');

      const upddate = [];
      const cardPrice = [];

      rows.forEach(row => {
        const date = row.querySelector('input[type="text"]').value;
        const price = parseFloat(row.querySelector('input[type="number"]').value);
        if (date && !isNaN(price)) {
          upddate.push(date);
          cardPrice.push(price);
        }
      });

      result[cardId] = {
        upddate,
        displayName: [displayName],
        cardPrice
      };
    });

    return result;
  }
</script>

</body>
</html>
